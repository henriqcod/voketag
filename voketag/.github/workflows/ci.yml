name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Lint scan-service
        working-directory: services/scan-service
        run: go vet ./...
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Lint factory-service
        working-directory: services/factory-service
        run: pip install ruff && ruff check .
      - name: Lint blockchain-service
        working-directory: services/blockchain-service
        run: pip install ruff && ruff check .
      - name: Lint admin-service
        working-directory: services/admin-service
        run: pip install ruff && ruff check .

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: voketag
          POSTGRES_PASSWORD: voketag
          POSTGRES_DB: voketag
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U voketag -d voketag"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Test scan-service
        working-directory: services/scan-service
        run: go test ./...
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Test factory-service
        working-directory: services/factory-service
        run: pip install -r requirements.txt pytest pytest-asyncio httpx && pytest tests/ -v
      - name: Test admin-service
        working-directory: services/admin-service
        env:
          DATABASE_URL: postgresql+asyncpg://voketag:voketag@localhost:5432/voketag
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret
        run: |
          pip install -r requirements.txt
          pytest tests/test_health.py tests/test_auth.py tests/test_users_protected.py -v --ignore=tests/integration

  trivy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "1"
          ignore-unfixed: true

  sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: "auto"

  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Terraform validate
        run: terraform -chdir=infra/terraform init -backend=false && terraform -chdir=infra/terraform validate

  e2e:
    name: E2E (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install frontend app dependencies
        working-directory: frontend/app
        run: npm ci

      - name: Install E2E dependencies and Playwright
        working-directory: tests/e2e
        run: npm ci && npx playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: tests/e2e
        run: npm run test:e2e -- --project=chromium
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # WebServer in playwright.config starts frontend/app

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 7
